/* Copyright (c) 2010 HomeAway, Inc.
* All rights reserved.  http://homeaway.github.io/calendar-widget/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(function(){var e=window.jQuery,t=window.Backbone,a=window._,r=function(r){this.Model=t.Model.extend({initialize:function(){var t=this.get("defaultDate"),r=e.extend(!0,[],this.get("calendar"));a.bindAll(this,"formatDate","getDefaultDates","copyDate","makeDate","resolveDates","setDataBounds","reverseFormatDate","getReservationsById"),r=e.merge(r,this.getDefaultDates()),this.set("calendar",r),t?this.setDataBounds(this.reverseFormatDate(t)):this.setDataBounds(new Date)},copyDate:function(e){return new Date(e.getTime())},makeDate:function(e,t){return e=e?this.copyDate(e):new Date,t&&t.months&&e.setMonth(e.getMonth()+t.months),t&&t.days&&e.setDate(e.getDate()+t.days),e},setDataBounds:function(e){return this.set({endDate:this.formatDate(this.makeDate(e,{months:12})),startDate:this.formatDate(this.makeDate(e,{months:-12})),defaultDate:this.formatDate(e)}),!1},defaults:{calendar:[],startCalendarDate:void 0,endCalendarDate:void 0},parse:function(t){return t.calendar=this.resolveDates(t.calendar,t.reservations),t.calendar=e.merge(this.getDefaultDates(),t.calendar),t},resolveDates:function(t,a){function r(e,t){return{startDate:t?t.startDate:void 0,endDate:t?t.endDate:void 0,date:e.date,reservationId:e.reservationId,duration:(e.duration?e.duration:void 0)||(t.checkinDate===e.date?"pm":void 0)||(t.checkoutDate===e.date?"am":"full"),status:t?t.status?t.status.toLowerCase():"":"",guestFirstName:t?t.guestFirstName:void 0,guestLastName:t?t.guestLastName:void 0,checkinTime:t?t.checkinTime:void 0,checkoutTime:t?t.checkoutTime:void 0}}var n,s,i,d,o=[];for(n in t)if(s=a?a[t[n].reservationId]:void 0,t[n].startDate&&t[n].endDate){var l,h=t[n].endDate,u=t[n].startDate,c=this.makeDate(this.reverseFormatDate(h)),m=this.makeDate(this.reverseFormatDate(u)),D=t[n].reservationId,f=m;for(o.push(r({date:u,duration:"pm",reservationId:D},s)),l=Math.round(Math.abs((c-m)/864e5)),f=m,d=l-1;d>=1;d--)f.setDate(f.getDate()+1),o.push(r({date:this.formatDate(f),duration:"full",reservationId:D},s));o.push(r({date:h,duration:"am",reservationId:D},s)),delete a[t[n].reservationId]}else o.push(r(e.extend(!0,{date:n},t[n]),s));for(n in a)o.push(r({date:a[n].checkoutDate,reservationId:n},a[n]));for(i=o.length-1;i>=0;i--)for(d=o.length-1;d>=0;d--)if(i!==d&&o[i].date===o[d].date&&o[i].startDate&&o[i].endDate){if("full"===o[i].duration&&"full"===o[d].duration){this.reverseFormatDate(o[i].startDate)>this.reverseFormatDate(o[d].startDate)?o.splice(d,1):this.reverseFormatDate(o[i].startDate)<this.reverseFormatDate(o[d].startDate)?o.splice(i,1):this.reverseFormatDate(o[i].endDate)>this.reverseFormatDate(o[d].endDate)?o.splice(i,1):this.reverseFormatDate(o[i].endDate)<this.reverseFormatDate(o[d].endDate)?o.splice(d,1):"reserve"===o[i].status?o.splice(d,1):o.splice(i,1);break}if("pm"===o[i].duration&&"full"===o[d].duration){o[d].duration="am";break}if("am"===o[i].duration&&"full"===o[d].duration){o[d].duration="pm";break}if("am"===o[i].duration&&"am"===o[d].duration){this.reverseFormatDate(o[i].endDate)>this.reverseFormatDate(o[d].endDate)?o.splice(i,1):this.reverseFormatDate(o[i].endDate)<this.reverseFormatDate(o[d].endDate)?o.splice(d,1):"reserve"===o[i].status?o.splice(d,1):o.splice(i,1);break}"pm"===o[i].duration&&"pm"===o[d].duration&&(this.reverseFormatDate(o[i].startDate)>this.reverseFormatDate(o[d].startDate)?o.splice(d,1):this.reverseFormatDate(o[i].startDate)<this.reverseFormatDate(o[d].startDate)?o.splice(i,1):"reserve"===o[i].status?o.splice(d,1):o.splice(i,1))}return o},getDefaultDates:function(){return this.resolveDates(e.extend(!0,{},this.get("defaultCalendar")),e.extend(!0,{},this.get("defaultCalendarEvents")))},getReservationsById:function(t){return a.where(e.extend(!0,[],this.get("calendar")),{reservationId:t})},formatDate:function(e){var t=""+e.getDate(),a=""+(e.getMonth()+1);return""+e.getFullYear()+"-"+(a[1]?a:"0"+a[0])+"-"+(t[1]?t:"0"+t[0])},reverseFormatDate:function(e){var t=e.split("-");return new Date(parseInt(t[0],10),parseInt(t[1],10)-1,parseInt(t[2],10))},url:function(){return this.get("url")+this.get("propertyId")+"?startDate="+this.get("startDate")+"&endDate="+this.get("endDate")}}),e.datepicker._updateDatepicker.modified||(e.datepicker._updateDatepicker_original=e.datepicker._updateDatepicker,e.datepicker._updateDatepicker=function(t){e.datepicker._updateDatepicker_original(t);var a=this._get(t,"afterShow");a&&a.apply(t.input?t.input[0]:null)},e.datepicker._updateDatepicker.modified=!0),this.View=t.View.extend({initialize:function(r){var n=this;a.bindAll(this,"fetchData","extendOptionsFunction");for(var s in r.clicked)this.extendOptionsFunction(s,r.clicked);e.extend(!0,this,{clicked:r.clicked,hovered:r.hovered,error:r.error,endCalendar:r.endCalendar,hoverClass:r.hoverClass,hoverClassStart:r.hoverClassStart,hoverClassEnd:r.hoverClassEnd,fetching:r.fetch,currentElement:void 0}),t.Layout||(a.bindAll(this,"afterRender"),this.on("render",this.afterRender,this)),this.model.on("error",function(e){n.$el.trigger("error",e),n.error(e)}),this.model.on("change:startDate",function(){n.fetchData(r.fetch)}),this.fetchData(r.fetch)},extendOptionsFunction:function(e,t){var a=this,r=t[e];t[e]=function(t,n){a.$el.trigger(e,[t,n]),r.call(this,t,n)}},fetchData:function(e){var t=this;return this.fetching=e,this.afterRender(),this.model.get("propertyId")&&this.fetching&&this.model.fetch({complete:function(){t.fetching=!1,t.afterRender()}}),!1},createCalendar:function(t){var a=t.el,r=t.isEndCalendar,n=t.endCalendar,s=t.startCalendar,i=e.extend(!0,[],this.model.get("calendar")),d=this,o=this.model.reverseFormatDate(this.model.get("defaultDate"));this.model.get("locale");var l;a.datepicker("destroy").datepicker({minDate:this.model.get("minDate"),maxDate:this.model.get("maxDate"),defaultDate:o,firstDay:this.model.get("startOfWeek"),showButtonPanel:this.model.get("showButtonPanel"),numberOfMonths:this.model.get("numberOfMonths"),beforeShowDay:function(e){var t,a,s,o=d.model.get("startCalendarDate"),l=d.model.get("endCalendarDate"),h=d.model.hoveredEndDate,u=d.model.hoveredStartDate,c=[];for(e=d.model.formatDate(e),a=i.length-1;a>-1;a--)i[a].date===e&&c.push(" "+i[a].duration+"-"+i[a].status.toLowerCase()+" X"+i[a].reservationId+"X");return 2===c.length&&-1!==c[0].indexOf("pm-")&&c[1].indexOf("am-")&&(s=c[0],c[0]=c[1],c[1]=s),t=d.model.reverseFormatDate(e),n?l>t&&t>o||o>t&&t>u||o&&l&&""+o==""+t&&""+l==""+o||o&&u&&o>u&&""+o==""+t?c.push(d.hoverClass):o&&""+o==""+t||u&&""+u==""+t?c.push(d.hoverClassStart):l&&""+l==""+t&&c.push(d.hoverClassEnd):r&&(h>o&&t>o&&h>t||l&&t>o&&l>t||o&&l&&""+o==""+t&&""+l==""+o?c.push(d.hoverClass):o&&""+o==""+t?c.push(d.hoverClassStart):(l&&""+t==""+l||h&&""+t==""+h)&&c.push(d.hoverClassEnd)),[!0,c.join(""),""]},onChangeMonthYear:function(e,t){if(d.fetching){var a,r,n=d.model.reverseFormatDate(d.model.get("startDate")),s=d.model.reverseFormatDate(d.model.get("endDate")),i=d.model.get("numberOfMonths"),o=i,l=0,h=0,u=new Date(e,t-1,1);if("[object Array]"===Object.prototype.toString.call(i))for(o=0,r=i.length-1;r>=0;r--)o+=i[r];l=12*(u.getFullYear()-n.getFullYear()),l-=n.getMonth()+1,l+=u.getMonth(),a=new Date(u.setMonth(u.getMonth()+o-2)),h=12*(s.getFullYear()-a.getFullYear()),h-=a.getMonth()+1,h+=s.getMonth(),(1>h||1>l)&&d.model.setDataBounds(new Date(e,t-1,1))}return!1},afterShow:function(){function t(e){return-1!==e.indexOf("reserve")?"reserve":-1!==e.indexOf("hold")?"hold":-1!==e.indexOf("delete")?"delete":-1!==e.indexOf("cancel")?"cancel":-1!==e.indexOf("unavailable")?"unavailable":-1!==e.indexOf("inquiry")?"inquiry":""}function n(t,r,n){if("inquiry"!==n){var s,i,d,o,l;if(i=a.find(".X"+t+"X"),r)for(l=i.length-1;l>=0;l--)s=e(i[l]),o=s.attr("class").split("X"),o[1]===t?(o[0]=o[0].replace("full-"+n,"full-"+n+"-hover"),o[0]=o[0].replace("am-"+n,"am-"+n+"-hover"),o[0]=o[0].replace("pm-"+n,"pm-"+n+"-hover")):(o[2]=o[2].replace("full-"+n,"full-"+n+"-hover"),o[2]=o[2].replace("am-"+n,"am-"+n+"-hover"),o[2]=o[2].replace("pm-"+n,"pm-"+n+"-hover")),s.attr("class",o.join("X"));else for(l=i.length-1;l>=0;l--)s=e(i[l]).unbind("mousemove"),d=s.attr("class"),d=d.replace(/-hover/g,""),s.attr("class",d)}}(r?e(".ui-state-default"):e(".ui-state-default","[class*=X]")).hover(function(){var s,i,o,h,u=e(this).parent().attr("class"),c=u.split("X"),m=d.model.hoveredEndDate,D=d.model.hoveredStartDate;-1!==u.indexOf("X")&&(s=c[1],c.length-1>3?e(this).unbind("mousemove").mousemove(function(a){var r=e(this).parent().offset(),o=a.pageX-r.left,h=a.pageY-r.top,u=e(this).parent().width()/2;n(s,!1,i),n(c[3],!1,i),u>o&&u>h?(i=t(c[0]),s=c[1],"inquiry"===i&&(i=c[2],s=c[3])):(i=t(c[2]),s=c[3],"inquiry"===i&&(i=c[0],s=c[1])),l!==s&&(d.currentElement=e(this),d.hovered.on(e(this),d.model.getReservationsById(s))),l=s,i=t(i),n(s,!0,i)}):(l=s,i=t(u),n(s,!0,i)),d.currentElement=e(this),d.hovered.on(e(this),d.model.getReservationsById(s))),e(this).parent().attr("onclick")&&(o=e(this).parent().attr("onclick").split(","),h=d.model.reverseFormatDate(o[2]+"-"+(parseInt(o[1],10)+1)+"-"+e(this).html()),!r||m&&""+m==""+h?D&&""+D==""+h||(d.model.hoveredStartDate=h,a.datepicker("refresh")):(d.model.hoveredEndDate=h,a.datepicker("refresh")))},function(){var t=e(this).parent().attr("class"),a=t.split("X"),r=a[1];a.length-1>3&&(n(a[3],!1,""),d.currentElement=e(this),d.hovered.off(e(this),d.model.getReservationsById(r))),r&&(n(r,!1,""),d.currentElement=e(this),d.hovered.off(e(this),d.model.getReservationsById(r)))})},onSelect:function(e,t){var o,h,u=d.model.get("startCalendarDate"),c=d.model.get("endCalendarDate"),m=e.split("/"),D=m[2]+"-"+m[0]+"-"+m[1],f=d.model.get("startIsEndMinimum");for(t.inline=!1,o=i.length-1;o>=0;o--)i[o].date===D&&i[o].reservationId===l&&(d.clicked[i[o].status.toLowerCase()]?d.clicked[i[o].status.toLowerCase()](d.currentElement,i[o]):r?s.trigger(i[o].status.toLowerCase(),d.currentElement,i[o]):a.trigger(i[o].status.toLowerCase(),d.currentElement,i[o]));r?(newSelectedEndDate=d.model.reverseFormatDate(D),c&&""+newSelectedEndDate==""+c||a.trigger("changed"),c=newSelectedEndDate,d.model.set("endCalendarDate",c)):(h=d.model.reverseFormatDate(D),u&&""+h==""+u||a.trigger("changed"),u=h,f&&n.datepicker("option","minDate",u),n&&d.model.set("startCalendarDate",u))},onClose:function(){var e=d.model.get("startCalendarDate"),t=d.model.get("endCalendarDate");d.model.hoveredEndDate,d.model.hoveredStartDate,d.model.hoveredStartDate=void 0,d.model.hoveredEndDate=void 0,n&&(a.datepicker("refresh").trigger("blur"),e&&(e>t||!t)&&(t=new Date(e.getTime()),t.setDate(t.getDate()+1),d.model.set("endCalendarDate",t),n.datepicker("setDate",t),n.trigger("changed"))),r&&(a.datepicker("refresh").trigger("blur"),(!e||e>t)&&(e=new Date(t.getTime()-1),d.model.set("startCalendarDate",e),s.datepicker("setDate",e),s.trigger("changed")))}})},afterRender:function(){var t=this.model.get("startCalendarDate"),a=this.model.get("endCalendarDate"),r=this;return this.createCalendar({el:this.$el,isEndCalendar:!1,endCalendar:this.endCalendar?e(this.endCalendar):void 0,startCalendar:void 0}),t&&this.$el.datepicker("setDate",t),this.endCalendar&&(e(this.endCalendar).on("click",function(){r.model.get("startCalendarDate")||(e(this).trigger("blur"),r.$el.trigger("focus"))}),this.createCalendar({el:e(this.endCalendar),isEndCalendar:!0,endCalendar:void 0,startCalendar:this.$el}),a&&e(this.endCalendar).datepicker("setDate",a)),this.$el.append('<div class="calendar-loading" style="width: '+this.$el.width()+"px; height: "+this.$el.height()+"px; display:"+(this.fetching?"block":"none")+';"></div>'),this}}),r.language&&(e.datepicker.regional.custom={closeText:r.language.closeText,prevText:r.language.previous,nextText:r.language.next,currentText:r.language.currentText,monthNames:r.language.monthNames,monthNamesShort:r.language.monthNamesShort,dayNames:r.language.dayNames,dayNamesShort:r.language.dayNamesShort,dayNamesMin:r.language.dayNamesMin,weekHeader:r.language.weekHeader,dateFormat:"mm/dd/yy",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},e.datepicker.setDefaults(e.datepicker.regional.custom)),r=e.extend(!0,{},e.fn.calendar.defaults,r),this.model=this.model||new this.Model({defaultDate:r.defaultDate,numberOfMonths:r.numberOfMonths,propertyId:r.propertyId,defaultCalendar:r.calendar,defaultCalendarEvents:r.reservations,url:r.url,startOfWeek:r.startOfWeek,minDate:r.minDate,maxDate:r.maxDate,startCalendarDate:r.startCalendarDate,endCalendarDate:r.endCalendarDate,startIsEndMinimum:r.startIsEndMinimum,showButtonPanel:r.showButtonPanel}),this.view=this.view||new this.View({el:r.el,model:this.model,clicked:r.clicked,error:r.error,fetch:r.fetch,hovered:r.hovered,endCalendar:r.endCalendar,hoverClass:r.hoverClass,hoverClassStart:r.hoverClassStart,hoverClassEnd:r.hoverClassEnd})},n=e.fn.calendar;e.fn.calendar=function(t){return this.each(function(){var a=e(this),n=a.data("calendar"),s="object"==typeof t&&t;s||(s={}),s.el=a,n||a.data("calendar",n=new r(s)),"string"==typeof t&&n[t]()})},e.fn.calendar.Constructor=r,e.fn.calendar.noConflict=function(){return e.fn.calendar=n,this},e.fn.calendar.defaults={endCalendar:void 0,hoverClass:"",hoverClassStart:"",hoverClassEnd:"",startOfWeek:0,defaultDate:void 0,endDate:void 0,startDate:void 0,propertyId:void 0,numberOfMonths:1,fetch:!0,minDate:void 0,maxDate:void 0,startCalendarDate:void 0,endCalendarDate:void 0,startIsEndMinimum:!1,showButtonPanel:!1,calendar:{},reservations:{},clicked:{inquiry:function(){},unavailable:function(){},hold:function(){},reserve:function(){},"delete":function(){}},hovered:{on:function(){},off:function(){}},error:function(){},url:"",language:void 0}})();